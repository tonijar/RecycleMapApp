<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" manifest="recyclemapapp.appcache">
	<head>
		<title>Mapa del reciclaje</title>
		<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"/>
		<meta charset="ISO-8859-1"/>
		<meta name="viewport" content="width=device-width"/>
		<link rel="stylesheet" href="lib/leaflet.css" />
		<script src="lib/leaflet.js"></script>

		<!-- GeoCSV: https://github.com/joker-x/Leaflet.geoCSV -->
		<script src="lib/leaflet.geocsv.js"></script>

		<!-- jQuery 1.9.1: http://jquery.com/ -->
		<script src="lib/jquery.js"></script>

		<script type="text/javascript">
			// Wen current location successfully found --> add circle
			function onLocationFound(e) {
				L.circle(e.latlng, e.accuracy / 2).addTo(map);
			}

			// When current location fails --> alert message
			function onLocationError(e) {
				alert(e.message);
			}
		</script>

		<!-- Favourite icon -->
		<link href="images/recycle-marker-favicon.png" rel="icon" type="image/x-icon" />
	</head>
	<body>
		<div id="map" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"> </div>
		<script type="text/javascript">
			// Show map centered at current position.
			var map = L.map('map');
			map.locate({
				setView : true,
				maxZoom : 14
			})
			L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution : 'Maps by &copy; <a href="http://openstreetmap.org" target="_blank">OpenStreetMap</a> contributors \
				 <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.0/" target="_blank">\
				 <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/2.0/80x15.png" /></a>',
				maxZoom : 19
			}).addTo(map);

			// Location functions
			map.on('locationfound', onLocationFound);
			map.on('locationerror', onLocationError);

			// Custom locations
			var geo_csv = {};
			map.removeLayer(geo_csv);
			geo_csv = L.geoCsv(null, {
				titles : ['lat', 'lng', 'popup'],
				fieldSeparator : ';',
				lineSeparator : '\n',
				deleteDobleQuotes : true,
				firstLineTitles : true,
				onEachFeature : function(feature, layer) {
					var popup = '';
					for (var clave in feature.properties) {
						var title = geo_csv.getPropertyTitle(clave);
						popup += '<b>' + title + ': </b>';
						if (title == "Web") {
							popup += '<a href="' + feature.properties[clave] + '" target="blank">Enlace</a>';
						} else {
							popup += feature.properties[clave];
						}
						popup += '<br />';
					}
					layer.bindPopup(popup);
				},
				pointToLayer : function(feature, latlng) {
					return L.marker(latlng, {
						icon : L.icon({
							iconUrl : 'images/recycle-marker-icon-min.png',
							shadowUrl : 'lib/images/marker-shadow.png',
							iconSize : [41, 41],
							shadowSize : [41, 41],
							shadowAnchor : [13, 20]
						})
					});
				}
			});

			// Retrieve locations CSV and add them to map
			$.ajax({
				type : 'GET',
				dataType : 'text',
				url : 'csv/locations.csv',
				contentType: "text/csv;charset=ISO-8859-1",
				error : function() {
					alert('No se han podido cargar los datos');
				},
				success : function(csv) {
					geo_csv.addData(csv);
					map.addLayer(geo_csv);
				}
			});
		</script>
	</body>
</html>
