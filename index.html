<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Recycle Map</title>
		<link rel="stylesheet" href="lib/leaflet.css" />
		<script src="lib/leaflet.js"></script>

		<!-- GeoCSV: https://github.com/joker-x/Leaflet.geoCSV -->
		<script src="lib/leaflet.geocsv.js"></script>

		<!-- jQuery 1.8.3: http://jquery.com/ -->
		<script src="lib/jquery.js"></script>

		<script type="text/javascript">
			// Wen current location successfully found --> add circle
			function onLocationFound(e) {
				L.circle(e.latlng, e.accuracy / 2).addTo(map);
			}

			// When current location fails --> alert message
			function onLocationError(e) {
				alert(e.message);
			}
		</script>
	</head>
	<body>
		<div id="map" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>
		<script type="text/javascript">
			// Show map centered at current position.
			var map = L.map('map');
			map.locate({
				setView : true,
				maxZoom : 14
			})
			L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution : 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>',
				maxZoom : 18
			}).addTo(map);

			// Location functions
			map.on('locationfound', onLocationFound);
			map.on('locationerror', onLocationError);

			// Custom locations
			var geo_csv = {};
			map.removeLayer(geo_csv);
			geo_csv = L.geoCsv(null, {
				titles : ['lat', 'lng', 'popup'],
				fieldSeparator : ';',
				lineSeparator : '\n',
				deleteDobleQuotes : true,
				firstLineTitles : true,
				onEachFeature : function(feature, layer) {
					var popup = '';
					for (var clave in feature.properties) {
						var title = geo_csv.getPropertyTitle(clave);
						popup += '<b>' + title + ': </b>';
						if (title == "Web") {
							popup += '<a href="' + feature.properties[clave] + '" target="blank">Enlace</a><br /><br />';
						} else {
							popup += feature.properties[clave] + '<br /><br />';
						}
					}
					layer.bindPopup(popup);
				},
				pointToLayer : function(feature, latlng) {
					return L.marker(latlng, {
						icon : L.icon({
							iconUrl : 'images/recycle-marker-icon.png',
							shadowUrl : 'lib/images/marker-shadow.png',
							iconSize : [41, 41],
							shadowSize : [41, 41],
							shadowAnchor : [13, 20]
						})
					});
				}
			});

			// Retrieve locations CSV and add them to map
			$.ajax({
				type : 'GET',
				dataType : 'text',
				url : 'locations.csv',
				error : function() {
					alert('No se han podido cargar los datos');
				},
				success : function(csv) {
					geo_csv.addData(csv);
					map.addLayer(geo_csv);
				}
			});
		</script>
	</body>
</html>
